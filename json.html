<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>JSON Key/Value Editor</title>
    <style>
        :root { --primary: #3b82f6; --bg: #f8fafc; --text: #1e293b; --key-color: #8b5cf6; --val-color: #059669; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { display: grid; grid-template-columns: 420px 1fr; gap: 20px; height: 90vh; }
        .panel { background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e2e8f0; }
        .panel-header { padding: 12px 18px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-weight: 700; font-size: 14px; color: #64748b; }
        
        /* 輸入區 */
        textarea { flex: 1; border: none; padding: 20px; font-family: 'Fira Code', monospace; font-size: 13px; line-height: 1.6; resize: none; outline: none; background: #ffffff; color: #334155; }
        
        /* 樹狀編輯區 */
        #tree-container { flex: 1; overflow-y: auto; padding: 25px; font-family: 'Fira Code', monospace; }
        .tree-node { margin-left: 24px; border-left: 1px solid #e5e7eb; padding-left: 12px; position: relative; }
        .tree-item { margin: 6px 0; display: flex; align-items: center; gap: 4px; }
        
        /* 編輯框樣式 */
        input { border: 1px solid transparent; background: transparent; padding: 2px 6px; border-radius: 4px; font-size: 14px; transition: all 0.2s; }
        input:hover { background: #f1f5f9; }
        input:focus { border-color: var(--primary); background: white; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        .key-input { color: var(--key-color); font-weight: 600; text-align: right; }
        .val-input { color: var(--val-color); flex: 1; }
        
        .toggle { cursor: pointer; color: #94a3b8; width: 16px; font-size: 12px; user-select: none; }
        .bracket { color: #94a3b8; font-weight: bold; }
        .error-msg { color: #ef4444; font-size: 12px; padding: 8px 18px; background: #fee2e2; border-top: 1px solid #fecaca; }
        .nav-back { margin-bottom: 15px; display: inline-block; text-decoration: none; color: var(--primary); font-weight: 600; }
        .index-label {
            background: transparent !important;
            border: none !important;
            font-style: italic;
            opacity: 0.7;
        }
    </style>
</head>
<body>

<a href="index.html" class="nav-back">← 返回首頁</a>

<div class="container">
    <div class="panel">
        <div class="panel-header">Raw Input (JSON / Object)</div>
        <textarea id="jsonInput" placeholder="在此貼入內容..."></textarea>
        <div id="errorDisplay" class="error-msg" style="display: none;"></div>
    </div>

    <div class="panel">
        <div class="panel-header">Editable Tree View (Click to edit Key or Value)</div>
        <div id="tree-container"></div>
    </div>
</div>

<script>
    const inputArea = document.getElementById('jsonInput');
    const treeContainer = document.getElementById('tree-container');
    const errorDisplay = document.getElementById('errorDisplay');
    let currentData = {};

    // 預設範例內容
    const defaultExample = `[
  {
    id: 1,
    name: "Product A",
    details: {
      price: 100,
      stock=50, // 自動修復等號
    },
    tags: ["New", "Sale"],
  },
]`;

    inputArea.value = defaultExample;

    function handleInput() {
        let raw = inputArea.value.trim();
        if (!raw) { treeContainer.innerHTML = ''; return; }

        try {
            // 智能修復：尾端逗號與等號轉冒號
            const repaired = raw.replace(/,\s*([\]}])/g, '$1')
                               .replace(/([{,]\s*[\w\d_]+)\s*=\s*/g, '$1:');
            
            currentData = new Function(`return (${repaired})`)();
            errorDisplay.style.display = 'none';
            renderTree();
        } catch (e) {
            errorDisplay.innerText = "語法錯誤: " + e.message;
            errorDisplay.style.display = 'block';
        }
    }

    function renderTree() {
        treeContainer.innerHTML = '';
        treeContainer.appendChild(createNode(currentData, null, currentData));
    }

    function createNode(val, key, parentRef) {
        const container = document.createElement('div');
        container.className = 'tree-node';

        const isObject = typeof val === 'object' && val !== null;
        const isArray = Array.isArray(val);
        const isParentArray = Array.isArray(parentRef); // 判斷父層是否為陣列

        const itemLine = document.createElement('div');
        itemLine.className = 'tree-item';

        // Key 編輯功能
        if (key !== null) {
            const keyInput = document.createElement('input');
            
            if (isParentArray) {
                // 如果父層是陣列，Key 就是 Index：禁止編輯，改變顏色
                keyInput.className = 'key-input index-label';
                keyInput.value = `[${key}]`;
                keyInput.readOnly = true; 
                keyInput.style.color = '#94a3b8'; // 灰色
                keyInput.style.cursor = 'default';
            } else {
                // 一般物件 Key：可以編輯，紫色
                keyInput.className = 'key-input';
                keyInput.value = key;
                keyInput.onchange = (e) => {
                    const newKey = e.target.value;
                    parentRef[newKey] = parentRef[key];
                    delete parentRef[key];
                    syncToTextarea();
                };
            }
            
            keyInput.style.width = (keyInput.value.length * 9 + 20) + 'px';
            itemLine.appendChild(keyInput);
            itemLine.appendChild(document.createTextNode(': '));
        }

        // ... (後續 Object 展開與 Value 編輯邏輯維持不變)
        if (isObject) {
            const toggle = document.createElement('span');
            toggle.className = 'toggle';
            toggle.innerText = '▼';
            
            const bracketOpen = document.createElement('span');
            bracketOpen.className = 'bracket';
            bracketOpen.innerText = isArray ? '[' : '{';

            itemLine.prepend(toggle);
            itemLine.appendChild(bracketOpen);

            const childrenContainer = document.createElement('div');
            Object.keys(val).forEach(k => {
                childrenContainer.appendChild(createNode(val[k], k, val));
            });

            toggle.onclick = () => {
                const isHidden = childrenContainer.style.display === 'none';
                childrenContainer.style.display = isHidden ? 'block' : 'none';
                toggle.innerText = isHidden ? '▼' : '▶';
            };

            const bracketClose = document.createElement('div');
            bracketClose.className = 'bracket';
            bracketClose.innerText = isArray ? ']' : '}';

            container.appendChild(itemLine);
            container.appendChild(childrenContainer);
            container.appendChild(bracketClose);
        } else {
            const valInput = document.createElement('input');
            valInput.className = 'val-input';
            valInput.value = JSON.stringify(val);
            valInput.onchange = (e) => {
                try {
                    parentRef[key] = JSON.parse(e.target.value);
                } catch {
                    parentRef[key] = e.target.value;
                }
                syncToTextarea();
            };
            itemLine.appendChild(valInput);
            container.appendChild(itemLine);
        }

        return container;
    }

    function syncToTextarea() {
        inputArea.value = JSON.stringify(currentData, null, 2);
    }

    inputArea.addEventListener('input', handleInput);
    handleInput(); // 初始執行一次預覽範例
</script>
</body>
</html>